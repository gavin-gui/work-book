#<center>Mongodb学习笔记
@(guichao)[java]   				      


----------


[toc]


----------


## 第一章  简介
> 
 MongoDB是一种强大、灵活、可扩展的数据存储方式。它扩展了关系数据库的众多有用功能，如辅助索引、范围查询(range query)和排序。

1.**丰富的数据模型**
>   **MongoDB**是面向文档的数据库，不是关系数据库。<br/>
>   基本的思路是将原来的“行”所谓概念换成更加灵活的“文档”模型。面向文档的方式可以将文档或数组内嵌进来。<br/>
>   MongoDB没有模式：文档的键不会事先定义也不会固定不变

2.**容易扩展**
>     

3.**丰富的功能**>    
 
4.**不牺牲速度**
>    

5.**简便的管理**
>    

6.**其它内容**
>    


## 第二章 入门
>  <i class="icon-list"></i>MongoDB的基本概念：
>  - 文档是MongoDB中数据的基本单元，类似于数据库管理系统中的行。
>  -  集合，可以看作没有模式的表。
>  -  MongoDB的耽搁实例可以容纳多个独立的数据库，每一个都有自己的集合和权限。
>  -  MongoDB自动简洁但该能强大的JavaScript shell，用于管理MOngoDB的实例和操作数据库。
>  -  每个文档都有一个特殊的键“_id”，它在文档所处的集合中是唯一的。

### 2.1 **文档**
`文档是MongoDB的核心概念`。多个键及其关联的值有序地放在一起便是文档。每种编程语言表示的方式不太一样，例如，在JavaScript里面，文档表示为对象：
``` json
	{"greeting":"Hello,world!"}
```
这个文档只有一个键"geeting",文档也可以有多个键/值对，如：
``` json
	{"greeting":"Hello,world!","foo":3}
```
- 文档中的键值对是有序的[^1]，上面的文档和下面的文档是不同的 
``` json
	{"foo":3,"greeting":"Hello,world!"}
```
- 文档中的值不仅可以是双引号里面的字符串，还可以是其他几种类型
- 文档的键是字符串。除了少数情况，键可以使用任意utf-8字符。
   - 键不能包含\0（空字符），这个字符用来表示键的结尾。
   - .和$有特别的含义，只有在特定情况下才能使用。
   - 以下划线”_“开头的键是保留的，虽然这个不是严格要求的

MongoDB不但区分类型，也区分大小写。例如，下面的两个文档是不同的：

    {”foo“:3}
    {"foo":"3"}
一下文档也是不同的：

    {"foo":3}
    {"Foo":3}
 
 <i class="icon-tag"></i>还有一个重要的事项需要注意，`MongoDB的文档不能有重复键`。例如，以下文档是非法的：

    {"greeting":"Hello,world!","greeting":"Hello,MongoDB!"}

### 2.2 **集合**
`集合是一组文档`。如果说MongoDB宅的文档类似于关系数据库中的行，那么集合就如同表。

#### 2.2.1 无模式
`集合是无模式的。这意味着一个集合中的文档可以是各式各样的`。例如，下面的两个文档可以存在于同一个文档里面：

    {"greeting":"Hello,MongoDB!"}
    {"foo":3}
<i class="icon-tag"></i>注意，上面的文档不光是值类型不同（字符串和整数），它们的键也可以完全不一的。因为集合里面可以放任何文档。随之而来的一个问题：“还有必要使用多个集合吗？”问得好！如果没有对各种文档划分模式，那么为什么还要使用多个集合呢？下面是一些理由：
- 把各种各样的文档混在一个集合里面，无论对于开发者还是对于管理者来说都是噩梦。开发者要么确保每次查询只返回需要的文档种类，那么让执行查询的应用程序来处理所有不同类型的文档。如果查询博客文章还要剔除那些含有作者数据的文章，就很让人恼火。
- 在一个集合中查询特定类型的文档在速度上也很不划算，分开做多个集合要快得多。
- 把同种类型的文档放在一个集合里面，这样数据会更加集中。
- 当创建索引的时候，文档会有附加结构（尤其是只有唯一索引的时候）。索引是按照集合来定义的。把同种类型的文档放入同一个集合里面，可以使集合更加有效。

#### 2.2.2 命名
我们可以通过名字来标识集合。集合命名可以满足下列条件的任意utf-8字符串。
- 集合命名不能是空字符串“”。
- 集合命名不能含有\0字符（空字符），这个字符表示集合名的结尾。
- 集合名不能以“system.”开头，这是为系统集合保留的前缀。
- 用户创建的集合名字不能含有保留字符$

#### 2.2.3 子集合
组织集合的一种惯例是使用“.”字符分开的按命名空间划分的子集合。例如，一个带有博客功能的应用包含两个集合，分别是blog.posts和blog.authors。这样做的目的只是为了使集合组织结构更好些，也就是说blog这个集合（这里根本就不需要存在）及其子集合没有任何关系。
虽然子集合没有特别的地方，但还是有用，很多MongoDB工具中都包含子集合。
- GridFS是一种存储大文件的协议，使用子集合来存储文件的元数据，这样就与内容分开了。
- MongoDB的Web控制台通过子集合的方式将数据组织在DBTOP部分。
- 绝大多数驱动程序都提供语法糖，为访问指定集合的子集合提供方便。

`在MongoDB中使用子集合来组织数据是很好的方法`，在此强烈推荐。

### 2.3 数据库
 MongoDB中多个文档组成集合，同样多个集合可以组成数据库。一个MongoDB实例可以承载多个数据库，它们之间可以视为完全独立的。每个数据库都有独立的权限控制，即便是在硬盘上，不同的数据库也放置在不同的文件中。将一个应用的所有数据都存储在同一个数据库中的做法就很好。要想在同一个MongoDB服务器上存放多个应用或者用户的数据，就要使用不同的数据库。
和集合一样，数据库也可以同个名字来标示。数据库的名字可以满足以下条件的任意utf-8字符串：
- 不能是空字符串“”。
- 不得含有' '（空格）、.、$、/、\和\0（空字符）。
- 应全部小写。
- 最多64字节。

要记住一点，数据库名最终会变成文件系统里的文件，这也就是如此多限制的原因。
有一些数据库名是保留的，可以直接访问这些有特殊作用的数据库。这些数据库如下：
- admin
从权限的角度看，这是“root”数据库。要是将一个用户添加到数据库，这个用户自动继承所有数据库的权限。一些特定的服务器终端命令也只能从这个数据库运行，比如列出所有的数据库或者关闭服务器。

- local
这个数据永远不会被复制，也以用来存储限于单台服务器的任意集合（关于复制和本地数据库详见第9章）。

- config
当MongoDB用于分片设置时，config数据库在内部使用，用于保存分片的相关信息。

把数据库的名字放到集合的前面，得到的就是集合的全限定名，成为命名空间。

### 2.4  启动MongoDB
MongoDB一般作为网络服务器来运行，客户端可以连接到该服务器并执行操作。要启动该服务器，需要运行mongod可执行文件：

    $ ./mongod

或者windows下，这样操作：

    $ mongod.exe

mongod在没有参数的情况下会默认使用数据目录/data/db（在Windows下是C:\data\db\），并使用27017端口。如果数据库目录不存在或者不可写，服务器会启动失败。所以再启动MongoDB钱，创建数据目录（比如mkdir -p /data/db），并确保对该目录的写权限是很重要的。如果端口被占用，启动也会失败。通常这是由于MongoDB实例已经运行了。

服务器会打印版本和系统信息，然后等待连接。默认情况下，MongoDB监听27017端口。

mongod还会启动一个非常基本的HTTP服务器，监听数据比端口号高1000的端口，也就是28017端口。这意味着你可以通过浏览器访问http://localhost:28017来获取数据库的管理信息。
 
 在启动服务器的shell下可以键入Ctrl-C来完全停止mongod的运行。

### 2.5 MongoDB shell
MongoDB自带一个JavaScript shell，可以从命名行与MongoDB实例交互。这个shell非常有用，通过它可以执行管理操作、检查运行实例，亦可以做其他尝试。这个mongo shell对于使用MongoDB来说是至关重要的工具。

#### 2.5.1 运行shell
运行mongo启动shell：

    $ ./mongo
shell 会在启动时自动连接MongoDB服务器，所以要确保在使用shell之前启动mongod。

shell是功能完备的Javascript解释器，可以运行任何JavaScript程序，为了证明这一点我们进行几个简单的运算：

    > x = 200
    200
    > x / 5
    40
还可以充分利用JavaScript的标准库。

    > function factorial (n) {
	    if (n <= 1) return 1;
	    return n * factorial(n-1);
      }
    > factorial(5)
    120

<i class="icon-tag"></i>注意，可以使用多行命令。这个shell会检测输入的JavaScript语句是否写完，如果没有写完还可以在下一行接着写。

#### 2.5.2 MongoDB客户端
虽然能运行任意JavaScript程序很酷，但shell的真正威力还在于它是一个独立的MongoDB客户端。开启的时候，shell会连接到MongoDB服务器的test数据库，并将这个数据库连接赋值给全局变量db。这个变量是通过shell访问MongoDB的主要入口。

shell会有一些非JavaScript语法的扩展，是为了方便习惯于SQL shell的用户而添加的。这些扩展并不提供额外的功能，但是他们是很棒的语法糖。例如，最重要的操作之一就是选择要使用的数据库：

    > use foobar
    switched to db foobar
现在如果看看db，会发现其只指向foobar数据库：

    > db
    foobar
因为这是一个JavaScript shell，所以键入的一个变量会将变量的值转换成为字符串（这里就是数据库名）并打印出来。

可以通过db变量来访问其中的集合。例如db.baz放回当前数据库baz集合。既然现在可以在shell访问集合，那么基本上就可以执行所有的数据库操作了。

#### 2.5.3 shell中的基本操作
在shell查看操作数据会用到4个基本操作：创建、读取、更新和删除（CRUD）。

1. 创建
insert函数添加一个文档到集合里。例如，假设要存储一篇博客文章。首先，创建一个局部变量post，内容是代表文档的JavaScript对象。里边会有"tile"，"content"和"date"（发表日期）几个键。
``` javascript
> post = {"title":"My Blog Post",
 "content":"Here's mys blog post.",
 "date":new Date()
}
```

这个对象是个有效的MongoDB文档，所以可以用insert方法将其保存到blog集合中：

    > db.blog.insert(post)
    
这篇文章已经被保存到数据库里面了。可以调用集合的find方法来查看一下：

    > db.blog.find()
    {
	    "_id": ObjectId("4b23......"),
	    "title": ".......",
	    "content":".......",
	    "date": "......."
    }

除了我们输入的键/值对完整的被保存下来，还有一个额外添加的键"_id" 。

2. 读取
find会返回集合里面的所有文档。若只是想查看一个文档，可以使用findOne：
``` markdown
> db.blog.findOne()
{
	.......
}
```

find和findOne可以接受查询文档形式的限定条件。


3. 更新
--TODO
- [ ] 待续
4. 删除
--TODO







[^1]:<i class="icon-info"></i>通常文档中键的顺序并不重要。实际上，有些编程语言对文档的呈现根本就不顾及顺序（如Pyrhton的字典，Perl和Ruby 1.8中的散列）。这些语言的驱动包含特殊的机制，会在少数不要的情况下制定文档的排序。本书会时常提到这些情况。


